{% extends 'base.html' %}
{% block title %}Manage Course{% endblock %}

{% block content %}
<style>
    a {
        color: #007bff;
        text-decoration: none
    }

    button {
        padding: 6px 12px;
        cursor: pointer
    }

    .course-box {
        border: 1px solid #ccc;
        padding: 20px;
        margin-top: 10px;
        border-radius: 6px
    }

    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold
    }

    .editdelete {
        display: flex;
        gap: 15px;
        align-items: center
    }

    .edit-course-box {
        border: 1px solid #ddd;
        padding: 20px;
        margin-top: 15px;
        background: #fafafa;
        border-radius: 6px;
        max-width: 750px;
        display: none;
        }

       

    .edit-course-box form p {
        display: grid;
        grid-template-columns: 150px auto;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px
    }

    .edit-course-box input[type="text"],
    .edit-course-box input[type="file"],
    .edit-course-box select,
    .edit-course-box textarea {
        max-width: 450px;
        padding: 6px 8px;
        border: 1px solid #bbb;
        border-radius: 4px
    }

    .edit-course-box textarea {
        min-height: 90px
    }

    .edit-course-box input[type="checkbox"] {
        margin: 0
    }

    .edit-course-box button {
        margin-right: 10px
    }

    .video-wrapper {
    width: 100%;
    max-width: 100%;
    aspect-ratio: 12 / 3;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    }

    .video-wrapper video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }


    .section {
        margin-top: 20px
    }

    .section-title {
        display: flex;
        justify-content: space-between;
        font-weight: bold
    }

    .lessons {
        margin-left: 25px;
        margin-top: 8px
    }

    .lesson {
        display: flex;
        justify-content: space-between;
        margin: 4px 0
    }

    .section-quiz {
        margin: 8px 0 12px 25px;
        font-weight: bold
    }

    #addSectionContainer {
        border: 1px dashed #aaa;
        padding: 10px;
        margin-top: 10px;
        display: none
    }
</style>



<div class="course-box">

    <div class="content-header">
        <h3>{{ course.title }}</h3>

        <div class="editdelete">
            <a href="javascript:void(0)" onclick="showEditCourse()">Edit Course</a>

            <a href="{% url 'delete_course' course.id %}"
                onclick="return confirm('Are you sure you want to delete this course?');">
                Delete Course
            </a>

            <button onclick="openAddSection()">+ Add Section</button>
        </div>
    </div>

    {% if preview_lesson and preview_lesson.video %}
    <div style="margin-bottom:20px; padding:15px; border:1px solid #ddd; border-radius:6px; background:#f9fafb;">
    
        <h4 style="margin-bottom:8px;">ðŸŽ¬ Course Preview (Student View)</h4>
    
        <div class="video-wrapper">
            <video controls>
                <source src="{{ preview_lesson.video.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
    
        <p style="margin-top:6px; color:#555;">
            Preview Lesson: <strong>{{ preview_lesson.title }}</strong>
        </p>
    
    </div>
    {% endif %}

    <div class="edit-course-box" id="editCourseBox" {% if request.GET.edit != "1" %}style="display:none" {% endif %}>
        <h4>Edit Course</h4>

        <form method="post" action="{% url 'edit_course' course.id %}" enctype="multipart/form-data">
            {% csrf_token %}
            {{ course_form.as_p }}
            <button type="submit" onclick="hideEditCourse()">Save Changes</button>
            <button type="button" onclick="hideEditCourse()">Cancel</button>
        </form>
    </div>

    <div id="addSectionContainer">
        <form method="post" id="sectionForm">
            {% csrf_token %}
            <input type="text" name="title" id="sectionTitle" placeholder="Section title" required>
            <input type="number" name="order" id="sectionOrder" placeholder="Order">
            <button type="submit">Save</button>
            <button type="button" onclick="toggleAddSection()">Cancel</button>
        </form>
    </div>

    <hr>

    {% for section in sections %}
    <div class="section">

        <div class="section-title">
            <span>â–¶ {{ section.title }}</span>
            <span class="editdelete">
                <a href="javascript:void(0)"
                    onclick="openEditSection('{{ section.id }}','{{ section.title }}','{{ section.order }}')">
                    Edit
                </a>
                <a href="{% url 'delete_section' section.id %}" onclick="return confirm('Delete this section?');">
                    Delete
                </a>
            </span>
        </div>

        <div class="section-quiz">
            {% if section.quiz %}
            <a href="{% url 'manage_quiz' section.quiz.id %}">Manage Test</a>
            {% else %}
            <form method="post" action="{% url 'add_quiz' section.id %}">
                {% csrf_token %}
                <input type="text" name="title" placeholder="Section Test Title" required>
                <button type="submit">Add Test</button>
            </form>
            {% endif %}
        </div>

        <div class="lessons">
            {% for lesson in section.lessons.all %}
            <div class="lesson">
                <span>â€¢ {{ lesson.title }}</span>
                <span class="editdelete">
                    <a href="{% url 'edit_lesson' lesson.id %}">Edit</a>
                    <a href="{% url 'delete_lesson' lesson.id %}" onclick="return confirm('Delete this lesson?');">
                        Delete
                    </a>
                </span>
            </div>
            {% empty %}
            <p>No lessons added yet.</p>
            {% endfor %}

            <a href="{% url 'add_lesson' section.id %}">
                <button>+ Add Lesson</button>
            </a>
        </div>

    </div>
    {% empty %}
    <p>No sections available.</p>
    {% endfor %}

</div>

<script>
    function openAddSection() {
        document.getElementById("sectionForm").action = "{% url 'add_section' course.id %}"
        document.getElementById("addSectionContainer").style.display = "block"
    }
    function openEditSection(id, title, order) {
        const f = document.getElementById("sectionForm")
        f.action = "{% url 'edit_section' 0 %}".replace("0", id)
        document.getElementById("sectionTitle").value = title
        document.getElementById("sectionOrder").value = order
        document.getElementById("addSectionContainer").style.display = "block"
    }
    function toggleAddSection() {
        document.getElementById("addSectionContainer").style.display = "none"
    }

    function showEditCourse() {
        document.getElementById("editCourseBox").style.display = "block";
    }

    function hideEditCourse() {
        document.getElementById("editCourseBox").style.display = "none";
    }

</script>

{% endblock %}